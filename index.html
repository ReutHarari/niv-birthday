<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>×™×•× ×”×•×œ×“×ª 32 ×œ× ×™×‘×•×© ğŸ‰</title>

<style>
:root{
  --bg:#020617;
  --card:#111827;
  --accent:#f97316;
  --muted:#9ca3af;
  --success:#22c55e;
  --error:#ef4444;
  --chip:#0b1220;
  --stroke:rgba(255,255,255,.08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Arial;
  background:var(--bg);
  color:#fff;
  direction:rtl;
  text-align:center;
}

.app{
  max-width:440px;
  margin:auto;
  min-height:100vh;
  padding:24px;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card{
  width:100%;
  background:var(--card);
  border-radius:24px;
  padding:24px;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
  animation:fadeIn .35s ease;
  border:1px solid var(--stroke);
}

.progress{
  font-size:14px;
  color:var(--muted);
  margin-bottom:12px;
}

h2{margin:0 0 10px}
p{margin:0 0 10px; line-height:1.7; color:var(--muted)}

button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:16px;
  border:none;
  font-size:16px;
  cursor:pointer;
}

.primary{
  background:var(--accent);
  color:#020617;
  font-weight:700;
}

.secondary{
  background:#1f2937;
  color:#fff;
}

.rescue{
  background:#064e3b;
  color:#ecfeff;
}

button:disabled{
  opacity:.45;
  cursor:not-allowed;
}

input{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:14px;
  border:none;
  font-size:16px;
  direction:rtl;
  text-align:center;
}

.feedback{
  margin-top:10px;
  font-size:14px;
}
.success{color:var(--success)}
.error{color:var(--error)}

.infoBox{
  margin-top:14px;
  background:var(--chip);
  border-radius:16px;
  padding:14px;
  border:1px solid rgba(255,255,255,.06);
}
.infoLine{
  color:#e5e7eb;
  margin:6px 0;
  line-height:1.6;
}
.mono{
  font-family:ui-monospace, Menlo, Consolas, monospace;
  direction:ltr;
  text-align:center;
  display:inline-block;
}

/* ========= TASTE STATIONS ========= */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:16px;
}

.option{
  border-radius:20px;
  padding:16px;
  cursor:pointer;
  transition:transform .12s ease, filter .12s ease, opacity .12s ease;
  border:1px solid rgba(255,255,255,.12);
  position:relative;
  overflow:hidden;
  min-height:160px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  box-shadow:0 10px 24px rgba(0,0,0,.35);
}

.option::after{
  content:"";
  position:absolute;
  inset:-60px -60px auto auto;
  width:140px;
  height:140px;
  background:radial-gradient(circle, rgba(255,255,255,.28), rgba(255,255,255,0) 60%);
  transform:rotate(18deg);
  pointer-events:none;
}

.option:hover{
  transform:translateY(-2px) scale(1.01);
  filter:saturate(1.05) brightness(1.05);
}

.option.disabled{
  background:linear-gradient(135deg, #0b1220, #0b1220);
  cursor:not-allowed;
  opacity:.55;
  transform:none;
  filter:none;
  box-shadow:none;
}

.optLabel{
  font-weight:900;
  color:#fff;
  font-size:18px;
  letter-spacing:.2px;
  text-shadow:0 8px 18px rgba(0,0,0,.35);
}

.answer{
  margin-top:12px;
  background:rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.16);
  padding:10px 12px;
  border-radius:16px;
  color:#fff;
  font-weight:900;
  width:100%;
  max-width:240px;
}

@keyframes pop{
  0%{transform:scale(.98); opacity:.6}
  100%{transform:scale(1); opacity:1}
}
.answer{animation:pop .16s ease}

.o1{ background:linear-gradient(135deg, #fb7185 0%, #f97316 55%, #facc15 110%); }
.o2{ background:linear-gradient(135deg, #38bdf8 0%, #22c55e 60%, #a78bfa 120%); }

.sep{
  margin-top:14px;
  border-top:1px dashed rgba(255,255,255,.14);
  padding-top:12px;
}
.smallNote{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}

/* Gematria block */
.gematria{
  margin-top:14px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
}
.gLine{
  color:#e5e7eb;
  font-weight:700;
  margin:10px 0;
  line-height:1.7;
}
.dot{
  display:inline-block;
  width:6px;height:6px;
  border-radius:999px;
  background:rgba(255,255,255,.35);
  margin:0 8px;
  transform:translateY(-1px);
}

/* Photo block */
.photoWrap{
  margin-top:14px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:12px;
}
.photo{
  width:100%;
  display:block;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 10px 24px rgba(0,0,0,.35);
}

/* Blessing text */
.blessing{
  margin-top:14px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:16px;
  line-height:1.85;
  color:#e5e7eb;
  white-space:pre-wrap;
}

/* Upload preview + end screen image */
.previewWrap{
  margin-top:14px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:12px;
}
.previewImg{
  width:100%;
  display:block;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 10px 24px rgba(0,0,0,.35);
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:none}
}
</style>
</head>

<body>
<div class="app">
  <div id="screen" class="card"></div>
</div>

<script>
const STORAGE_KEY = "birthday_allinone_v20_split_blessing";
const MAGIC_PHRASE = "×—×’×™×’×•×ª 32 ×œ× ×™×‘×•×© ××ª×—×™×œ×•×ª ×¢×›×©×™×•";
const RIDDLE_ANSWER = "×©×•×§ ×”×›×¨××œ";
const PICKUP_ACCEPTED = ["×›×¨×˜×™×¡ ×˜×¢×™××•×ª", "×›×¨×˜×™×¡ ×”×˜×¢×™××•×ª ×”×›×¨××œ"];

const PHOTO_FILE = "recreate.JPG";
const GPS_LAT = "32.0541";
const GPS_LNG = "34.7495";
const SPA_ACCEPTED = ["×©×‘×˜", "12 ×”×©×‘×˜×™×"];

/* âœ… Fill your blessing text here */
const BLESSING_TITLE = "×œ× ×™×‘×•×© ××”×•×‘×™ â¤ï¸";
const BLESSING_TEXT = "×¦×¨×™×›×” ×œ×”×›× ×™×¡ ×¤×” ××ª ×”×‘×¨×›×” ×©×œ×™";

/* Image chosen in upload step:
   Persist in localStorage for end screen. */
function setBlessingImage(dataUrl){
  try{ localStorage.setItem("birthday_blessing_img", dataUrl || ""); }catch(e){}
}
function getBlessingImage(){
  return localStorage.getItem("birthday_blessing_img") || "";
}
let blessingImageDataUrl = getBlessingImage() || null;

const state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  step: 0,
  rescueWifeUsed: false,
  rescueCoinUsed: false,
  tasteChoices: {}
};

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function normalize(str){ return (str||"").trim().replace(/\s+/g," ").toLowerCase(); }
function setFeedback(id, text, ok){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text;
  el.className = "feedback " + (ok ? "success" : "error");
}

const steps = [
  { type:"action", title:"×‘×•×§×¨ ×˜×•×‘ ××”×•×‘×™ â˜€ï¸",
    text:`×”×™×•× ×”×•× ×™×•× ×”×”×•×œ×“×ª ×©×œ×š, ××–×œ ×˜×•×‘!
×× ×™ ×¢×•×“ ×‘×˜×— ×™×©× ×” ××‘×œ ×”×›× ×ª×™ ×‘××™×•×—×“ ×‘×©×‘×™×œ×š
××ª ×”××¤×œ×™×§×¦×™×” ×”××’× ×™×‘×” ×”×–××ª ×©×ª×œ×•×•×” ××•×ª×š
×‘×›×œ ×©×œ×‘×™ ×”×™×•× - ×›×›×” ×©××ª×” ×‘×›×œ×œ
×œ× ×¦×¨×™×š ××•×ª×™ ğŸ˜‰

××‘×œ ××œ ×ª×“××’â€¦
×ª×›×£ ×× ×™ ××§×•× ×•× ×¦× ×œ×“×¨×š!`,
    button:"×× ×™ ××•×›×Ÿ ×œ×”×ª×—×™×œ ×‘×—×’×™×’×•×ª! ğŸ‰"
  },
  { type:"action", title:"×¨×’×¢×¢×¢ ğŸ˜´", text:"×¢×•×“ 5 ×“×§×•×ª...", button:"×“×™×™ ×¨×¢×•×ª ×–×” ×™×•× ×”×”×•×œ×“×ª ×©×œ×™ ××ª ×¦×¨×™×›×” ×œ×§×•×" },
  { type:"magic", title:"××•×§×™×™ ×§××ª×™...",
    text:`×¢×›×©×™×• ×× ×™ ×¦×¨×™×›×” ×œ×’×œ×•×ª ×œ×š ××ª ××™×œ×ª ×”×§×¡× ×‘×©×‘×™×œ ×©× ×•×›×œ ×œ×”×ª×—×™×œ ××ª ×”×™×•×.
××” ×—×©×‘×ª ×©×× ×™ ××ª×Ÿ ×œ×š ×‘×××ª ×œ×”××©×™×š ×‘×œ×¢×“×™?? ğŸ˜‰`,
    placeholder:"×›×ª×•×‘ ×›××Ÿ ××ª ××™×œ×ª ×”×§×¡×â€¦"
  },
  { type:"action", title:" ×ª×—× ×” ×¨××©×•× ×” ×œ×”×™×•× â˜•ğŸ°",
    text:`× ×ª×—×™×œ ××ª ×”×™×•× ×¢× ×”×”×¨×’×œ ×”××”×•×‘ ×¢×œ×™× ×•, ×¨×’×¢ ×©×œ ×‘×™×—×“ ×¨×§ ×©×œ ×©× ×™× ×• ×œ×¤× ×™ ×©×”×™×•× ××ª×—×™×œ - ×§×¤×” ×•×¢×•×’×” ×‘× ×—×ª.
×•×”×™×•× × ×ª×—×™×œ ×¢× ×”×¢×•×’×” ×”××”×•×‘×” ×¢×œ×™×š ×©×”×›× ×ª×™ ×‘××™×•×—×“ ×‘×©×‘×™×œ×š!
×©× ×ª×§×‘×œ ××ª ×”×¨××– ×œ×ª×—× ×” ×”×¨××©×•× ×” ×©×× ×—× ×• ×”×•×œ×›×™× ×œ×”×’×™×¢ ××œ×™×” ×”×™×•×.`,
    button:"×™××œ×œ×” × ×¢×‘×•×¨ ×œ×¨××– ×”×¨××©×•×Ÿ"
  },
  { type:"riddle", title:"×¨××– ×¨××©×•×Ÿ ğŸ§©",
    text:`×’×¨× ×• ×œ×™×“×• ×ª×§×•×¤×” ×™×¤×” ×‘×—×™×™×, 
×”×™×™×ª×™ ×—×•×–×¨×ª ××©× ×•××ª×” ×”×™×™×ª ××•×¦× ×‘××§×¨×¨ ×›××•×™×•×ª ×©×œ ×¢×œ×™× ×™×¨×•×§×™×, 
×‘×¦× ×¦× ×•×ª ×¢×•××“×™×.
×§×¤×” ×˜×•×‘ ××• ×‘×™×¨×” ×§×¨×”, 
×‘×–×× ×• ×”×™×• ×—×œ×§ ×‘×œ×ª×™ × ×¤×¨×“ ××”×©×’×¨×”
×¢×œ ××™×–×” ××§×•× ××“×•×‘×¨? `,
    placeholder:"×”×§×œ×“ ×ª×©×•×‘×”â€¦",
    answer:RIDDLE_ANSWER
  },
  { type:"pickup", title:"×‘×•× × ×¦× ×œ×“×¨×š! ğŸš¶â€â™‚ï¸",
    text:`×¢×œ×™×š ×œ×”×’×™×¢ ×œ×›×ª×•×‘×ª:`,
    placeholder:"××” ×§×™×‘×œ×ª??",
    accepted:PICKUP_ACCEPTED
  },
  { type:"action", title:"×‘×¨×•×š ×”×‘× ×œ×¡×™×•×¨ ×”×˜×¢×™××•×ª ×”×¢×¦×××™ ×©×œ× ×•! ğŸ´",
    text:`×™×© ×œ× ×• 6 ×ª×—× ×•×ª ××¤×ª×™×¢×•×ª, ×˜×¢×™××•×ª ×•××¨×’×©×•×ª!
×‘×›×œ ×ª×—× ×” ×ª×”×™×” ×œ×š ×‘×—×™×¨×” ××” ×œ××›×•×œ.

×ª×¦×˜×¨×š ×œ×‘×—×•×¨ ××‘×œ×™ ×œ×“×¢×ª ××” ×”×× ×” ×©×¢×•××“×ª ×××—×•×¨×™ ×”×”×’×“×¨×” â€”
×œ×š ×œ×¤×™ ×ª×—×•×©×ª ×”×‘×˜×Ÿ ×©×œ×š ğŸ˜‰
××‘×œ ××œ ×ª×“××’ â€” ×“××’×ª×™ ×œ×š ×œ×’×œ×’×œ×™ ×”×¦×œ×” ×œ×¨×’×¢×™× ×©×‘×”× ×”×”×—×œ×˜×” ×§×©×” ××™×“×™×™.

×•×¢×›×©×™×•â€¦ ×œ×ª×—× ×” ×”×¨××©×•× ×”!`,
    button:"×× ×™ ×¨×¢×‘ ×‘×•××™ × ×ª×—×™×œ! ğŸ¤¤"
  },

  { type:"taste", title:"×”×§×¨×™×¡×¤×™×•×ª", text:"×”×ª×—×œ×ª×™ ××ª ×”×‘×•×§×¨ ×‘×•×•×™×‘ ×©×œ:",
    options:[
      { label:"×œ×”×ª×—×‘×¨ ×œ×©×•×¨×©×™×", answer:"×”×‘×•×¨×™×§×” ×”××¤×•×¨×¡××ª ×©×œ ×©×•×§ ×”×›×¨××œ!", theme:"o1" },
      { label:"×‘×•×¢×˜ ×•×—×¨×™×£", answer:"×¡×™×’×¨ ×—×¨×™×£ ×××•×œ× ×‘×©×¨", theme:"o2" }
    ]
  },
  { type:"taste", title:"××¢×•×œ×” × ×¤×ª×— ×œ×™ ×”×ª××‘×•×Ÿ", text:"×‘× ×œ×™ ×œ×”××©×™×š ××ª ×”×™×•× ×‘:",
    options:[
      { label:'×—×•×´×œ', answer:"×¤×™×©&×¦×³×™×¤×¡", theme:"o1" },
      { label:"×”×›×™ ××§×•××™", answer:"××œ××•×•×— ×¤×™× ×•×§×™×", theme:"o2" }
    ]
  },
  { type:"taste", title:"×”××¤×•×¨×¡××•×ª", text:"×¢×›×©×™×• ×× ×™ ×¨×•×¦×” ×œ×˜×¢×•×:",
    options:[
      { label:"×× ×” ×™×•×¦××ª ×¨×™××œ×™×˜×™", answer:"×’×•×¨ ×—×¦×™×œ ×©×¢×‘×¨×” ××•×“×™×©×Ÿ ×‘××©×—×§×™ ×”×©×£!", theme:"o1" },
      { label:"×× ×” ××’×“×™×ª", answer:"×”×§×‘×‘ ×”××™×ª×•×œ×•×’×™ ×©×œ ×©×•×§ ×”×›×¨××œ!", theme:"o2" }
    ]
  },
  { type:"taste", title:"×”×’×™×¢ ×”×–××Ÿ ×œ×”×ª×¨×¢× ×Ÿ", text:" ××—×¨×™ ×›×œ ×”××•×›×œ ×”×–×” ×›×œ ××” ×©×‘× ×œ×™ ×–×” ××©×”×•:",
    options:[
      { label:"×§×œ×™×œ", answer:"××™×¥ ×‘×¨×™××•×ª", theme:"o1" },
      { label:"××¤× ×§", answer:"×§×¢×¨×ª ××¡××™", theme:"o2" }
    ]
  },
  { type:"taste", title:"×”×¤×¡×§×”", text:"×‘× ×œ×™ ×œ×¢×©×•×ª ×¢×¦×™×¨×” ×§×˜× ×” ×¢× ××©×”×•:",
    options:[
      { label:"××¢×•×¨×¨", answer:"×§×¤×” ×©×œ ×©×•×§", theme:"o1" },
      { label:"××©×›×¨", answer:"×‘×™×¨×ª ×‘×•×˜×™×§", theme:"o2" }
    ]
  },
  { type:"taste", title:"××—×¨×•× ×” ×—×‘×™×‘×”", text:"×œ×¡×™×•× ×× ×™ ××©××— ×œ×¨×’×¢:",
    options:[
      { label:"×× ×—×", answer:"××œ×‘×™ ×§×œ××¡×™", theme:"o1" },
      { label:"××¦× ×Ÿ", answer:"×’×œ×™×“×” ××™×˜×œ×§×™×ª", theme:"o2" }
    ]
  },

  { type:"gpsRiddle", title:"×¢×›×©×™×• ×›×©×”×‘×˜×Ÿ ××œ××” ××¤×©×¨ ×œ×”××©×™×š ×‘××¡×¢",
    text:`××—×¨×™ ×©×¡×™×™×× ×• ××ª ×¡×™×•×¨ ×”×˜×¢×™××•×ª ×©×œ× ×• ×× ×—× ×• ××•×›× ×™× ×œ×”××©×™×š ×œ×ª×—× ×” ×”×‘××” ×‘××¡×œ×•×œ, ×•×× ×›×‘×¨ ×“×™×‘×¨× ×• ×¢×œ ××¡×œ×•×œ ××– ×‘×•× × ×‘×—×Ÿ ××•×ª×š ×§×¦×ª ×‘× ×™×•×•×˜×™×.
×¢×œ×™×š ×œ×”×’×™×¢ ×œ× .×¦ ×”×‘× ××‘×œ ×‘×©×‘×™×œ ×œ×’×œ×•×ª ××•×ª×• ×¢×œ×™×š ×œ×¤×ª×•×¨ ××ª ×”×—×™×“×” ×‘×’×™××˜×¨×™×” -`,
    placeholder:'×›×ª×•×‘ ×›××Ÿ ××ª ×”× .×¦ (×œ×“×•×’××”: 32.0000, 34.0000)'
  },

  { type:"action", title:"×›×œ ×”×›×‘×•×“!",
    text:`×¢×œ×™×š ×œ× ×•×•×˜ ×œ× ×¦ - 34.7495 32.0541 
×©× ×ª×§×‘×œ ××ª ×”×‘×¨×›×” ×”××¨×’×©×ª ×•××ª ×”×¨××– ×”×‘×`,
    button:"×”×’×¢×ª×™ ×œ×™×¢×“"
  },

  { type:"photoMission", title:"×”×’×¢×ª ×œ×™×¢×“! ğŸ¯",
    text:`×¨×’×¢ ×œ×¤× ×™ ×©×× ×—× ×• ×¢×•×‘×¨×™× ×œ×‘×¨×›×” - ×™×© ×œ× ×• ××©×™××”! ×œ×©×—×–×¨ ××ª ×”×ª××•× ×” ×”×—××•×“×” ×”×–××ª ×©×œ× ×• ××©× ×ª 2013`
  },

  /* âœ… Step 17 (new): Blessing only */
  { type:"blessingTextOnly", title:BLESSING_TITLE, text:"" },

  /* âœ… Step 18 (new): Upload + PDF + continue */
  { type:"blessingUpload", title:"×¨×’×¢ ×œ×¤× ×™ ×©×××©×™×›×™×",
    text:"×™×© ×œ×”×¢×œ×•×ª ×œ×›××Ÿ ××ª ×”×ª××•× ×” ×”××©×•×—×–×¨×ª ×©×¢×›×©×™×• ×¦×™×œ×× ×• ×•×œ×™×™×¦× ×§×•×‘×¥ PDF ×‘×©×‘×™×œ ×©× ×•×›×œ ×œ×”×“×¤×™×¡ ×œ××–×›×¨×ª!"
  },

  /* Next: spa riddle */
  { type:"spaRiddle", title:"×¢×›×©×™×• ×”×’×™×¢ ×”×–××Ÿ ×œ×”×ª×¤× ×§ ğŸ’†â€â™‚ï¸",
    text:`×œ× × ×¡×™×™× ××ª ×”××¡×¢ ×‘×œ×™ ×œ×”×ª×¤× ×§ ×›××• ×©×¦×¨×™×š?
×¢×œ×™×š ×œ× ×•×•×˜ ×œ×¡×¤× ×©××ª ×©××• ×ª×“×¢ ×× ×ª×¤×ª×•×¨ ××ª ×”×—×™×“×” ×”×‘××”:

×›×©×”×™×™× ×• ×‘×“×¨×•× ×××¨×™×§×” ××• ×™×•×ª×¨ × ×›×•×Ÿ ×‘×‘×¨×–×™×œ, ×¤×’×© ××•×ª× ×• ×‘×—×•×¨ ×ª××”×•× ×™ ×‘××™×–×” ×‘×™×ª ×§×¤×”
×•×”×–××™×Ÿ ××•×ª× ×• ×œ××¨×•×—×ª ×©×™×©×™ ×™×—×“ ×¢× ×›×œ ×”×§×”×™×œ×” ×©×œ×• â€”
××” ×”×™×” ×©××• ×©×œ ×”×‘×—×•×¨ ××• ××” ×”×™×™×ª×” ×©××” ×©×œ ×”×§×”×™×œ×”?`,
    placeholder:"×›×ª×•×‘ ×›××Ÿ ××ª ×”×ª×©×•×‘×”â€¦"
  },

  { type:"action", title:"×›×œ ×”×›×‘×•×“! ğŸ¥³",
    text:`×”×ª×—× ×” ×”××—×¨×•× ×” ×©×œ× ×• ×”×•× ×¢×™×¡×•×™ ××¤× ×§ ×‘×¡×¤× ×©×‘×˜.
×–×” ×”×¨×’×¢ ×”××•×©×œ× ×œ×”×ª× ×§×•×ª, ×œ× ×•×— ×•×œ×”× ×•×ª ×‘×™×—×“ ×œ×¤× ×™ ×©×—×•×–×¨×™× ×”×‘×™×ª×” ×œ××¡×•×£ ××ª ×”×œ×‘.
××§×•×•×” ×©×”×™×” ×œ×š ×™×•× ×‘×œ×ª×™ × ×©×›×—!
×•××™×–×” ×›×™×™×£ ×©×™×© ×œ× ×• ×¢×•×“ ×“×™×™×˜ ×”×¢×¨×‘ ×œ×”×©×œ××ª ×”×™×•× ×”×›×™×¤×™ ×”×–×” ×©×œ× ×• ×‘×™×—×“!
××– ×™××œ×œ×” ×× ×—× ×• ×¦×¨×™×›×™× ×œ××”×¨!`,
    button:"×× ×™ ××•×›×Ÿ ×œ×”×ª×¤× ×§"
  },

  { type:"end", title:"××–×œ ×˜×•×‘ × ×™×‘×•×© ××”×•×‘×™! ğŸ‰", text:"" }
];

function next(){ state.step++; save(); render(); }
function resetAll(){
  state.step = 0;
  state.rescueWifeUsed = false;
  state.rescueCoinUsed = false;
  state.tasteChoices = {};
  blessingImageDataUrl = null;
  localStorage.removeItem("birthday_blessing_img");
  localStorage.removeItem(STORAGE_KEY);
  save();
  render();
}

function render(){
  const el = document.getElementById("screen");
  if(typeof state.step !== "number" || state.step < 0 || state.step >= steps.length){
    state.step = 0; save();
  }

  const s = steps[state.step];

  let html = `
    <div class="progress">×©×œ×‘ ${state.step + 1} ××ª×•×š ${steps.length}</div>
    <h2>${s.title}</h2>
    <p>${String(s.text||"").replace(/\n/g,"<br>")}</p>
  `;

  if(s.type === "action"){
    html += `<button class="primary" onclick="next()">${s.button}</button>`;
    el.innerHTML = html;
    return;
  }

  if(s.type === "magic"){
    html += `
      <input id="magicInput" placeholder="${s.placeholder}" />
      <button class="primary" onclick="checkMagic()">×”××©×š</button>
      <div id="magicFb" class="feedback"></div>
    `;
    el.innerHTML = html;
    return;
  }

  if(s.type === "riddle"){
    html += `
      <input id="riddleInput" placeholder="${s.placeholder}" />
      <button class="primary" onclick="checkRiddle()">×”××©×š</button>
      <div id="riddleFb" class="feedback"></div>
    `;
    el.innerHTML = html;
    return;
  }

  if(s.type === "pickup"){
    html += `
      <div class="infoBox">
        <div class="infoLine"><strong>×¢× ×§ ×”××©×§××•×ª - ××œ×™×¨×Ÿ</strong></div>
        <div class="infoLine">×›×ª×•×‘×ª: <span class="mono">×”×›×¨××œ 7</span> (×××—×•×¨×™ ×§×•×‘×” ×”×›×¨××œ)</div>
        <div class="infoLine">×•×œ××¡×•×¨ ×‘×—× ×•×ª ××ª ××¡×¤×¨ ×”×”×–×× ×”: <span class="mono">26206</span></div>
      </div>
      <p style="margin-top:14px;">×¨×§ ××—×¨×™ ×©×§×™×‘×œ×ª ××ª ×”×”×¤×ª×¢×” ××©× ××¤×©×¨ ×œ×”××©×™×š ×‘×™×•× â€” ××– ××” ×§×™×‘×œ×ª??</p>
      <input id="pickupInput" placeholder="${s.placeholder}" />
      <button class="primary" onclick="checkPickup()">×”××©×š</button>
      <div id="pickupFb" class="feedback"></div>
    `;
    el.innerHTML = html;
    return;
  }

  if(s.type === "taste"){
    html += renderTasteStation(s);
    el.innerHTML = html;
    return;
  }

  if(s.type === "gpsRiddle"){
    html += `
      <div class="gematria">
        <div class="gLine">× ×ª× ×” ×œ×• <span class="dot"></span> × ×¨×™ ××”×•×‘×” ×”×œ×‘ ××‘×</div>
        <div class="gLine">××ª× ×” <span class="dot"></span> ×‘×©×‘×™×œ ××‘</div>
      </div>

      <input id="gpsInput" placeholder="${s.placeholder}" inputmode="decimal" style="direction:ltr;text-align:center" />
      <button class="primary" onclick="checkGPS()">×”××©×š</button>
      <div id="gpsFb" class="feedback"></div>
    `;
    el.innerHTML = html;
    return;
  }

  if(s.type === "photoMission"){
    html += `
      <div class="photoWrap">
        <img class="photo" src="${PHOTO_FILE}" alt="×ª××•× ×” ×œ×©×—×–×•×¨" />
      </div>
      <button class="primary" onclick="next()">×©×—×–×¨× ×• ×•×× ×™ ××•×›×Ÿ ×œ×¢×‘×•×¨ ×œ×‘×¨×›×” ×”××¨×’×©×ª</button>
    `;
    el.innerHTML = html;
    return;
  }

  /* âœ… Step 17: Blessing only */
  if(s.type === "blessingTextOnly"){
    html += `
      <div class="blessing">${BLESSING_TEXT}</div>
      <button class="primary" onclick="next()">×”××©×š</button>
    `;
    el.innerHTML = html;
    return;
  }

  /* âœ… Step 18: Upload + PDF + continue */
  if(s.type === "blessingUpload"){
    const preview = blessingImageDataUrl ? `
      <div class="previewWrap">
        <img class="previewImg" src="${blessingImageDataUrl}" alt="×”×ª××•× ×” ×©× ×‘×—×¨×”" />
      </div>
    ` : "";

    html += `
      ${preview}

      <input id="blessingFile" type="file" accept="image/*" style="display:none" onchange="onBlessingFilePicked(event)" />

      <button class="secondary" onclick="pickBlessingImage()">×”×¢×œ×” ×ª××•× ×” ×œ×‘×¨×›×”</button>
      <button class="secondary" onclick="exportBlessingPDF()" ${blessingImageDataUrl ? "" : "disabled"}>×™×™×¦×•× ×œ-PDF (×“×¨×š ×”×“×¤×¡×”)</button>

      <button class="primary" onclick="next()">×•×¢×›×©×™×• ×œ×¨××– ×”××—×¨×•×Ÿ</button>

      <div class="smallNote" style="margin-top:10px;">
        ×‘××™×™×¤×•×Ÿ: ××—×¨×™ ×”×œ×—×™×¦×” ×¢×œ ×™×™×¦×•× â†’ ×™×™×¤×ª×— ××¡×š ×”×“×¤×¡×”, ×•××©× ×‘×—×¨×™ â€œ×©×™×ª×•×£ / ×©××™×¨×” ×œ×§×‘×¦×™×â€ ×›×“×™ ×œ×§×‘×œ PDF.
      </div>
    `;
    el.innerHTML = html;
    return;
  }

  if(s.type === "spaRiddle"){
    html += `
      <input id="spaInput" placeholder="${s.placeholder}" />
      <button class="primary" onclick="checkSpa()">×”××©×š</button>
      <div id="spaFb" class="feedback"></div>
    `;
    el.innerHTML = html;
    return;
  }

  if(s.type === "end"){
    const img = getBlessingImage();
    const imgHtml = img ? `
      <div class="previewWrap">
        <img class="previewImg" src="${img}" alt="×ª××•× ×” ××”×‘×¨×›×”" />
      </div>
    ` : "";

    html = `
      <div class="progress">×©×œ×‘ ${state.step + 1} ××ª×•×š ${steps.length}</div>
      <h2>${s.title}</h2>
      ${imgHtml}
      <button class="secondary" onclick="resetAll()">×—×–×¨×” ×œ×”×ª×—×œ×”</button>
    `;
    el.innerHTML = html;
    return;
  }

  el.innerHTML = html;
}

function renderTasteStation(s){
  const chosen = state.tasteChoices[state.step] || null;

  const optHtml = `
    <div class="grid">
      ${renderTasteOption(1, s.options[0], chosen)}
      ${renderTasteOption(2, s.options[1], chosen)}
    </div>
  `;

  let continueBtn = "";
  if(chosen){
    continueBtn = `<button class="primary" onclick="next()">×”××©×š ×œ×©×œ×‘ ×”×‘× â¡ï¸</button>`;
  }

  const lifelines = `
    <div class="sep">
      <button class="rescue" onclick="lifelineWife()" ${state.rescueWifeUsed ? "disabled" : ""}>
        ×× ×™ × ×•×ª×Ÿ ×œ××©×ª×™ ×œ×‘×—×•×¨
      </button>
      <button class="rescue" onclick="lifelineCoin()" ${state.rescueCoinUsed ? "disabled" : ""}>
        ×× ×™ ×¨×•×¦×” ×œ×ª×ª ×œ×’×•×¨×œ ×œ×”×—×œ×™×˜
      </button>
      <div class="smallNote">×›×œ ×’×œ×’×œ ×”×¦×œ×” × ×™×ª×Ÿ ×œ×©×™××•×© ×¤×¢× ××—×ª ×‘×œ×‘×“.</div>
    </div>
  `;

  return `${optHtml}${continueBtn}${lifelines}`;
}

function renderTasteOption(id, opt, chosen){
  const themeClass = opt.theme || (id === 1 ? "o1" : "o2");

  if(chosen && chosen !== id){
    return `
      <div class="option disabled">
        <div class="optLabel">${opt.label}</div>
      </div>
    `;
  }

  if(chosen === id){
    return `
      <div class="option ${themeClass}">
        <div class="optLabel">${opt.label}</div>
        <div class="answer">${opt.answer}</div>
      </div>
    `;
  }

  return `
    <div class="option ${themeClass}" onclick="chooseTaste(${id})">
      <div class="optLabel">${opt.label}</div>
    </div>
  `;
}

function chooseTaste(id){
  if(state.tasteChoices[state.step]) return;
  state.tasteChoices[state.step] = id;
  save();
  render();
}

/* Wife lifeline only disables */
function lifelineWife(){
  if(state.rescueWifeUsed) return;
  state.rescueWifeUsed = true;
  save();
  render();
}

function lifelineCoin(){
  if(state.rescueCoinUsed) return;
  state.rescueCoinUsed = true;
  const pick = Math.random() < 0.5 ? 1 : 2;
  if(!state.tasteChoices[state.step]) state.tasteChoices[state.step] = pick;
  save();
  render();
}

function checkMagic(){
  const v = document.getElementById("magicInput").value.trim();
  if(v === MAGIC_PHRASE){
    setFeedback("magicFb","âœ”ï¸ ××•×©×œ×. ×™×“×¢×ª×™ ×©××¤×©×¨ ×œ×¡××•×š ×¢×œ×™×š.", true);
    setTimeout(next, 650);
  }else{
    setFeedback("magicFb","âŒ ×œ× ×œ×â€¦ ×¢×•×“ ×œ× ××ª×—×™×œ×™× ×‘×œ×™ ×©×× ×™ ×¢×¨×” ğŸ˜‰", false);
  }
}

function checkRiddle(){
  const s = steps[state.step];
  const v = normalize(document.getElementById("riddleInput").value);
  if(v === normalize(s.answer)){
    setFeedback("riddleFb","âœ”ï¸ ×‘×•×œ! ×××©×™×›×™× ğŸ˜", true);
    setTimeout(next, 650);
  }else{
    setFeedback("riddleFb","âŒ ×›××¢×˜â€¦ ×ª×—×©×•×‘ ×¢×•×“ ×§×¦×ª ğŸ˜‰", false);
  }
}

function checkPickup(){
  const s = steps[state.step];
  const v = normalize(document.getElementById("pickupInput").value);
  const ok = s.accepted.some(a => normalize(a) === v);
  if(ok){
    setFeedback("pickupFb","âœ”ï¸ ×™×©! ×§×™×‘×œ×ª ××ª ×”×”×¤×ª×¢×”. ×××©×™×›×™×!", true);
    setTimeout(next, 650);
  }else{
    setFeedback("pickupFb","âŒ ×œ× ×–×”â€¦ ×ª×¡×ª×›×œ ×˜×•×‘ ××” ×§×™×‘×œ×ª ğŸ˜‰", false);
  }
}

/* âœ… GPS: accept both orders */
function checkGPS(){
  const raw = (document.getElementById("gpsInput").value || "").trim();
  const nums = raw.match(/-?\d+(?:\.\d+)?/g) || [];
  if(nums.length < 2){
    setFeedback("gpsFb","âŒ ×—×¡×¨ ×¤×” ××©×”×•â€¦ × ×¡×” ×œ×¨×©×•× ×©×ª×™ ×§×•××•×¨×“×™× ×˜×•×ª ğŸ˜‰", false);
    return;
  }
  const a = nums[0];
  const b = nums[1];

  const okNormal = (a === GPS_LAT && b === GPS_LNG);
  const okReverse = (a === GPS_LNG && b === GPS_LAT);

  if(okNormal || okReverse){
    setFeedback("gpsFb","âœ”ï¸ ××œ×•×£! ××¦××ª ××ª ×”× .×¦. ×××©×™×›×™×!", true);
    setTimeout(next, 650);
  }else{
    setFeedback("gpsFb","âŒ ×œ× ×‘×“×™×•×§â€¦ ×ª× ×¡×” ×©×•×‘. (×¨××–: 4 ×¡×¤×¨×•×ª ××—×¨×™ ×”× ×§×•×“×”)", false);
  }
}

function checkSpa(){
  const v = normalize(document.getElementById("spaInput").value);
  const ok = SPA_ACCEPTED.some(a => normalize(a) === v);
  if(ok){
    setFeedback("spaFb","âœ”ï¸ ×™××œ×œ×” ××ª×¤× ×§×™×! ğŸ˜Œ", true);
    setTimeout(next, 650);
  }else{
    setFeedback("spaFb","âŒ ×œ× ×–×”â€¦ ×ª×™×–×›×¨ ×‘×‘×¨×–×™×œ ğŸ˜‰", false);
  }
}

/* ===== Blessing image upload ===== */
function pickBlessingImage(){
  const input = document.getElementById("blessingFile");
  if(input) input.click();
}

function onBlessingFilePicked(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  if(file.size > 12 * 1024 * 1024){
    alert("×”×ª××•× ×” ×’×“×•×œ×” ××™×“×™×™. × ×¡×™ ×œ×‘×—×•×¨ ×ª××•× ×” ×§×˜× ×” ×™×•×ª×¨ ğŸ™‚");
    e.target.value = "";
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    blessingImageDataUrl = reader.result;
    setBlessingImage(blessingImageDataUrl);
    render();
  };
  reader.readAsDataURL(file);
}

/* ===== Export (most stable): print to PDF ===== */
function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function exportBlessingPDF(){
  if(!blessingImageDataUrl){
    alert("×§×•×“× ×”×¢×œ×™ ×ª××•× ×” ×œ×‘×¨×›×” ğŸ™‚");
    return;
  }

  const title = escapeHtml(BLESSING_TITLE);
  const blessing = escapeHtml(BLESSING_TEXT).replace(/\n/g,"<br>");

  const printableHtml = `
<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×‘×¨×›×” ×œ× ×™×‘×•×©</title>
<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,Arial;
    direction:rtl;
    text-align:center;
    color:#111;
    background:#fff;
  }
  .page{
    max-width:820px;
    margin:0 auto;
    padding:28px 22px 36px;
  }
  h1{ margin:0 0 12px; font-size:28px; }
  .bless{ margin:0 auto 18px; font-size:16px; line-height:1.9; }
  .imgWrap{
    margin:18px auto 0;
    border:1px solid #e5e7eb;
    border-radius:16px;
    padding:10px;
  }
  img{ width:100%; display:block; border-radius:12px; }
  @media print{ .page{ padding:18mm 14mm; } }
</style>
</head>
<body>
  <div class="page">
    <h1>${title}</h1>
    <div class="bless">${blessing}</div>
    <div class="imgWrap">
      <img src="${blessingImageDataUrl}" alt="×ª××•× ×”">
    </div>
  </div>
  <script>
    window.onload = () => { window.print(); };
  <\/script>
</body>
</html>`;

  const w = window.open("", "_blank");
  if(!w){
    alert("× ×—×¡× ×—×œ×•×Ÿ ×§×•×¤×¥. × ×¡×”/×™ ×œ××¤×©×¨ Pop-ups ×œ×“×£ ×”×–×” ×•××– ×œ×œ×—×•×¥ ×©×•×‘ ğŸ™‚");
    return;
  }
  w.document.open();
  w.document.write(printableHtml);
  w.document.close();
}

render();
</script>
</body>
</html>
